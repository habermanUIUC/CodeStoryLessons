<!DOCTYPE html><html lang='en'><head><title>Finding Mr. Potter</title><meta charset="utf-8"><style>/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}h1{font-size:2em;margin:.67em 0}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}strong{font-weight:bolder}code{font-family:monospace,monospace;font-size:1em}img{border-style:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}h1,h2,h3,p,pre{margin:0}ul{list-style:none;margin:0;padding:0}html{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";line-height:1.5}*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e2e8f0}img{border-style:solid}h1,h2,h3{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}code,pre{font-family:Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}img,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}.bg-gray-200{--bg-opacity:1;background-color:#edf2f7;background-color:rgba(237,242,247,var(--bg-opacity))}.bg-gray-300{--bg-opacity:1;background-color:#e2e8f0;background-color:rgba(226,232,240,var(--bg-opacity))}.bg-blue-200{--bg-opacity:1;background-color:#bee3f8;background-color:rgba(190,227,248,var(--bg-opacity))}.bg-blue-300{--bg-opacity:1;background-color:#90cdf4;background-color:rgba(144,205,244,var(--bg-opacity))}.border-gray-400{--border-opacity:1;border-color:#cbd5e0;border-color:rgba(203,213,224,var(--border-opacity))}.border-gray-500{--border-opacity:1;border-color:#a0aec0;border-color:rgba(160,174,192,var(--border-opacity))}.border-gray-600{--border-opacity:1;border-color:#718096;border-color:rgba(113,128,150,var(--border-opacity))}.rounded{border-radius:.25rem}.rounded-full{border-radius:9999px}.border-solid{border-style:solid}.border-0{border-width:0}.border{border-width:1px}.border-t{border-top-width:1px}.inline-block{display:inline-block}.inline{display:inline}.flex{display:flex}.justify-center{justify-content:center}.justify-around{justify-content:space-around}.float-right{float:right}.float-left{float:left}.clearfix:after{content:"";display:table;clear:both}.clear-both{clear:both}.font-serif{font-family:Georgia,Cambria,"Times New Roman",Times,serif}.font-semibold{font-weight:600}.font-bold{font-weight:700}.h-64{height:16rem}.text-xs{font-size:.75rem}.text-sm{font-size:.875rem}.text-base{font-size:1rem}.text-xl{font-size:1.25rem}.leading-none{line-height:1}.m-1{margin:.25rem}.m-2{margin:.5rem}.my-4{margin-top:1rem;margin-bottom:1rem}.my-6{margin-top:1.5rem;margin-bottom:1.5rem}.mt-1{margin-top:.25rem}.mb-1{margin-bottom:.25rem}.mt-2{margin-top:.5rem}.mr-2{margin-right:.5rem}.mb-2{margin-bottom:.5rem}.mt-3{margin-top:.75rem}.mr-3{margin-right:.75rem}.mb-3{margin-bottom:.75rem}.ml-3{margin-left:.75rem}.mt-4{margin-top:1rem}.mt-6{margin-top:1.5rem}.max-w-sm{max-width:24rem}.max-w-2xl{max-width:42rem}.object-contain{-o-object-fit:contain;object-fit:contain}.overflow-hidden{overflow:hidden}.p-1{padding:.25rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.py-3{padding-top:.75rem;padding-bottom:.75rem}.px-3{padding-left:.75rem;padding-right:.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.px-4{padding-left:1rem;padding-right:1rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.pl-3{padding-left:.75rem}.shadow-lg{box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05)}.shadow-inner{box-shadow:inset 0 2px 4px 0 rgba(0,0,0,.06)}.text-left{text-align:left}.text-center{text-align:center}.text-black{--text-opacity:1;color:#000;color:rgba(0,0,0,var(--text-opacity))}.text-gray-700{--text-opacity:1;color:#4a5568;color:rgba(74,85,104,var(--text-opacity))}.text-gray-800{--text-opacity:1;color:#2d3748;color:rgba(45,55,72,var(--text-opacity))}.whitespace-no-wrap{white-space:nowrap}.w-1\/2{width:50%}.w-full{width:100%}.text-tiny{font-size:.5rem!important}body{color:#000!important;font-size:1.25rem!important}.main-content{max-width:900px}.lesson{padding-left:15px!important;padding-right:10px!important;--bg-opacity:1;background-color:#edf2f7;background-color:rgba(237,242,247,var(--bg-opacity))}.main-content,html{font-family:Arial,Georgia,Verdana,"Times New Roman"!important}.lesson-footer-card,.lesson-overview-card{font-family:"Times New Roman"!important}.lesson-footer{margin-top:50px;margin-top:20px}video{height:auto;padding:.25rem;background-color:#87cefa;margin:0!important;padding:0!important}.lesson ul{list-style-position:inside;list-style-type:none;margin-left:1em}.lesson ul li{padding-left:1em;padding-right:5px}.lesson ul li::before{content:"‚Ä¢";padding-right:5px}span{white-space:nowrap}p.new{padding-top:0;padding-bottom:.5em}p.new+p{padding-top:.5em}h1,h2,h3{font-weight:700;margin-top:.25em!important;margin-bottom:.05em!important;font-family:Georgia,Cambria,"Times New Roman",Times,serif!important}h1{font-size:2em!important;clear:both;color:#000!important}div+h1,h2{margin-top:0!important}h2{margin-top:.5em!important;font-size:1.5em!important;clear:both;color:#8b0000!important}h3{font-size:1.25em!important;clear:both;color:#006400!important}ul{margin-bottom:30px}p.new a{text-decoration:underline}.lesson a{text-decoration:underline;color:#00f}.title-text{font-size:2rem}.shadow-lg{box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.5)}img.formula-block{margin-left:auto;margin-right:auto;margin-top:.25rem;margin-bottom:.75rem}img.center{-o-object-position:center;object-position:center;margin-left:auto;margin-right:auto}img.border{border:1px solid #021a40;margin-top:.5rem;margin-bottom:.75rem}img.iw400{height:auto;width:auto;max-width:400px}img.iw500{height:auto;width:auto;max-width:500px}img.iw300{height:auto;width:auto;max-width:300px}img.iw200{height:auto;width:auto;max-width:200px}img.iw100{height:auto;width:auto;max-width:100px}code{font-size:smaller}pre code{font-size:15px}pre code:not(.line-number){background:#f4f4f4;font-family:monospace;font-size:15px;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;cursor:default;touch-action:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent;clear:both;border:1px solid #ddd;color:#666;page-break-inside:avoid;display:block;min-width:840px;max-width:840px;overflow:scroll;line-height:1.6;margin-bottom:1.6em;padding:1em 1.5em;-moz-tab-size:2;-o-tab-size:2;tab-size:2;word-wrap:break-word;white-space:pre-wrap;border-left:3px solid #f36d33}div.code-starter>pre code{border-left:3px solid #fdff44!important;background-image:radial-gradient(rgba(0,150,0,.75),#000 120%);color:#fff;font:.9rem Inconsolata,monospace}div.code-starter>pre code::after{content:"\a$_"}</style>
<script src="https://kit.fontawesome.com/7efc4bcee2.js" crossOrigin="anonymous"></script>
<script>
    let stateCheck = setInterval(function(){
      if (document.readyState === 'complete') {
        clearInterval(stateCheck);
        let s1 = document.getElementById('start');
        // console.log('doc is ready', s1);
        if (s1) {
           s1.setAttribute('tabindex', '-1');
           s1.focus(); 
           s1.scrollIntoView({behavior: 'smooth'}); 
           setTimeout(function(){s1.blur()}, 500);
           // console.log('focus set');
        }
      }
    }, 200);
    </script>
</head><body class="lesson"><div class="main-content lesson bg-gray-200 text-black p-1 pl-3 font-serif"><div class="md-inner">
<div id="start" class="section">&nbsp;</div><h1 class="overview"></h1><div class="lesson-overview bg-gray-200 flex justify-center"><div class="text-center px-4 py-2 m-2"><div class="lesson-overview-card displaycard bg-blue-200 max-w-sm rounded overflow-hidden shadow-lg"><div>¬†</div><img alt="Text" class="object-contain h-64 w-full" src="https://raw.githubusercontent.com/habermanUIUC/CodeStoryLessons/main/lessons/dmap/projects/hp411/html/CodeChallenges-sm.png"/><div class="px-6 py-4"><div class="title-text text-center leading-none font-bold text-xl">Finding Mr. Potter</div><p class="text-center mt-2 text-gray-800 text-xl">using tf‚Ä¢idf for üßô 411 </p><div class="text-gray-700 text-base">¬†</div><div class="text-center mb-3"><span class="inline-block bg-gray-300 rounded-full px-3 py-1 text-sm font-semibold text-gray-700 mr-2">#tf‚Ä¢idf</span><span class="inline-block bg-gray-300 rounded-full px-3 py-1 text-sm font-semibold text-gray-700 mr-2">#projects</span></div><div class="flex border-t border-solid border-gray-500 shadow-inner justify-around bg-blue-300"><div class="text-gray-700 text-center px-4 m-2 text-sm"><span class="whitespace-no-wrap">D.M. &amp; the üêç</span></div><div class="text-gray-700 text-center px-4 m-2 text-sm"><span class="whitespace-no-wrap"><strong>Version:</strong> <!-- -->SP21</span></div></div><div class="text-gray-700 mt-1 text-center text-tiny">All Rights Reserved</div></div></div></div><div class="text-center px-4 py-2 m-2 w-1/2"><div class="displaycard bg-gray-200 max-w-sm rounded overflow-hidden shadow-lg"><div class="px-6 py-4 text-left"><div class="text-center font-bold text-xl">Finding Mr. Potter<br/><div><span>prerequisites</span><div class="text-center text-xs mb-2">(start only after finishing)</div><p class="max-w-sm text-gray-800 text-sm">‚¶ø <strong>tf‚Ä¢idf</strong></p><p class="max-w-sm text-gray-800 text-sm">‚¶ø <strong>tf‚Ä¢idf sklearn</strong></p><p class="max-w-sm text-gray-800 text-sm">‚¶ø <strong>cmaps</strong></p></div></div></div><div class="px-6 py-4 text-left text-gray-800"><div class="text-center font-bold text-xl">Colab Notes</div><p class="max-w-sm text-sm">1. <strong>Copy</strong> this notebook <img alt="copy2drive.png" class="inline-block" src="https://raw.githubusercontent.com/habermanUIUC/CodeStoryLessons/main/lessons/dmap/projects/hp411/html/copy2drive.png"/></p><p class="max-w-sm text-sm">2. <strong>Update</strong> the <strong><code>NET_ID</code></strong> in the notebook</p><p class="max-w-sm text-gray-800 text-sm">3. <strong>Hit ‚ñ∂Ô∏è¬†</strong> to install the INFO 490 IDE</p><div class="text-center font-bold text-xl">¬†</div><div class="text-center font-bold text-xl">Jupyter/PyCharm Notes</div><p class="max-w-sm text-gray-800 text-sm text-left">The testing framework does <strong>not work</strong> (at this time) for Jupyter  notebooks or local code development.</p></div></div></div></div><h1 class="section" id="section1">Finding Mr. Potter </h1><img alt="HPBooks.png" class="iw200 bg-blue-200 float-left mr-3 border mt-1 py-3" src="https://raw.githubusercontent.com/habermanUIUC/CodeStoryLessons/main/lessons/dmap/projects/hp411/html/HPBooks.png"/><p class="new">This project builds upon your tf‚Ä¢idf skills with the sklearn package. Specifically, 
you will use tf‚Ä¢idf to determine which document best matches a set of query
 words. Don't panic if you're not sure how to start, we will guide you
  through the process.  Always take the time to make sure you understand each
   step along the way.</p><div class="clear-both"></div><h2 id="the-setup">The Setup</h2><div class="clear-both border border-gray-600 float-left mr-3 mt-3"><video class="border-0" controls="" width="400"><source src="https://storage.googleapis.com/uicourse/lessons/harrypotter411.mp4" type="video/mp4"/></video></div><p class="new">You've been hired by a bookstore to write the search engine for finding the 
appropriate Harry Potter book based what the customer is interested in. For example, 
suppose a reader wants to learn about 'dementors'. Which Harry Potter book would you recommend? 
This of course would be difficult if you never read any of the books.  We are going 
to let the computer 'read' the entire collection for us (in milliseconds-second time !) 
and put the power of tf‚Ä¢idf behind the search engine. The video on the left shows 
what you need to demo to the bookstore owner.</p><h1 class="section" id="section2">The HP Corpus</h1><img alt="hp1.png" class="iw100 float-left m-1" src="https://raw.githubusercontent.com/habermanUIUC/CodeStoryLessons/main/lessons/dmap/projects/hp411/html/hp1.png"/><img alt="hp2.png" class="iw100 float-left m-1" src="https://raw.githubusercontent.com/habermanUIUC/CodeStoryLessons/main/lessons/dmap/projects/hp411/html/hp2.png"/><img alt="hp3.png" class="iw100 float-left m-1" src="https://raw.githubusercontent.com/habermanUIUC/CodeStoryLessons/main/lessons/dmap/projects/hp411/html/hp3.png"/><img alt="hp4.png" class="iw100 float-left m-1" src="https://raw.githubusercontent.com/habermanUIUC/CodeStoryLessons/main/lessons/dmap/projects/hp411/html/hp4.png"/><img alt="hp5.png" class="iw100 float-left m-1" src="https://raw.githubusercontent.com/habermanUIUC/CodeStoryLessons/main/lessons/dmap/projects/hp411/html/hp5.png"/><img alt="hp6.png" class="iw100 float-left m-1" src="https://raw.githubusercontent.com/habermanUIUC/CodeStoryLessons/main/lessons/dmap/projects/hp411/html/hp6.png"/><img alt="hp7.png" class="iw100 float-left m-1" src="https://raw.githubusercontent.com/habermanUIUC/CodeStoryLessons/main/lessons/dmap/projects/hp411/html/hp7.png"/><div class="clear-both"></div><p class="new">Luckily, this lesson has the text for all seven Harry Potter books. The text for each
 has already been normalized and tokenized (you will do that in another lesson!). 
 The text for each book is a single line of text. So all the punctuation, sentences, paragraphs, and 
   chapters are removed and the text is ready to be tokenized.  Each file is
    named with the prefix 'hp', followed by the book number. Let's take a look:</p><div class="ide code-starter clearfix"><pre><code>import LessonUtil as Util

def get_harry_potter():
   return Util.read_data_file('hp1.txt')

print(get_harry_potter()[0:17])</code></pre></div><h2 id="exercise-buildcorpus">Exercise: <code>build_corpus</code></h2><p class="new">Create a function named <code>build_corpus</code> with a single parameter <code>count</code></p><ul><li>count has a default value of 1</li><li>return a list with 'count' number of Harry Potter books.  So
<code>books = build_corpus(2)</code> would return the text from hp1.txt and hp2.txt.</li></ul><div class="ide code-starter clearfix"><pre><code></code></pre></div><p class="new">Once that is done, be sure to test it by implementing the following code (and 
remember how many unique words are in the first Harry Potter book).</p><pre><code>def test_corpus():
  c = build_corpus(2)
  print(len(c) == 2)
  print(c[0][0:17])
  print(c[1][0:31])

  doc1 = c[0]
  print(len(doc1.split()), len(set(doc1.split()))) 
  
test_corpus()
# print(ide.tester.test_function(build_corpus))</code></pre><h2 id="tfidf">TF‚Ä¢IDF</h2><p class="new">Of course the next big task is to convert the set of documents into TF‚Ä¢IDF
 vectors.  We can do that using the <code>TfidfVectorizer</code> class we discussed previously.</p><p class="new">As a reminder, <code>TfidfVectorizer</code> uses a <code>TfidfCountVectorizer</code> followed by a
 <code>TfidfTransformer</code>.  The <code>TfidfTransformer</code> simply converts a count matrix to a
 tf‚Ä¢idf representation.  The <code>TfidfVectorizer</code> implements the chain a bit more
 efficiently.</p><h3 id="create-the-tfidf-model-">Create the TF‚Ä¢IDF Model </h3><p class="new">Create a function named <code>build_tf_idf_model</code> which has two parameters:</p><ul><li><code>docs</code> a list of documents to consider</li><li><code>stopwords</code> a list of stopwords to consider</li></ul><p class="new">When you create the model, use the following default values (which we will dabble with later): </p><ul><li><code>use_idf=True</code></li><li><code>smooth_idf=True</code></li><li><code>sublinear_tf=True</code></li><li><code>norm=None</code></li><li><code>stop_words=stopwords</code> (the incoming parameter)</li></ul><p class="new">As a reminder (you should re-check the sklearn 
<a href="https://scikit-learn.org/stable/modules/generated/sklearn.feature_extraction.text.TfidfVectorizer.html" target="_blank">documentation</a> too):</p><pre><code>smooth_idf=True    # True: idf = 1 + log( (doc_N+1)/(df_n+1) )
                   # False idf = 1 + log(doc_N/df_n)
sublinear_tf=True  # True:  tf = 1 + log(term_count)
                   # False: tf = raw term count
norm=None,         # don't normalize tfidf results
use_idf=True       # False: only consider the counts</code></pre><h3 id="fit--transform">Fit &amp; Transform</h3><p class="new">Once you have the model built, simply call <code>fit_transform</code> on the incoming set
 of documents.  As a reminder, <code>fit_transform</code> is an efficient implementation 
of calling <code>fit</code> followed by <code>transform</code>: </p><ul><li><code>fit</code> builds the model.  It creates the idf vector</li><li><code>transform</code> creates the tf‚Ä¢idf vectors</li></ul><h3 id="return-a-tuple-vectorizer-matrix">Return a tuple (vectorizer, matrix)</h3><p class="new">Finally return BOTH the Vectorizer created and the matrix returned from
 <code>fit_transform</code></p><div class="ide code-starter clearfix"><pre><code>import warnings
warnings.simplefilter(action='ignore', category=FutureWarning)
warnings.simplefilter(action='ignore', category=UserWarning)
 
from sklearn.feature_extraction.text import TfidfVectorizer
def build_tf_idf_model(docs, stopwords=[]):

   # build the model &amp; matrix 
   # return the vectorizer, matrix
   return None,None</code></pre></div><p class="new">Once that is done, test it by printing the shape of the matrix.
What did you notice? </p><pre><code>def test_build(corpus):
    vec, matrix = build_tf_idf_model(corpus)
test_build(build_corpus(1))</code></pre><p class="new">You can also supply your own tokenizer for finer control (but we will not do 
that for this lesson):</p><pre><code>vec = TfidfVectorizer(..., tokenizer=tokenizer, analyzer='word')</code></pre><p class="new">Now you can also print out the tf‚Ä¢idf information for each document:</p><div class="ide code-starter clearfix"><pre><code>import pandas as pd
def print_tfidf(vec,matrix, n=0):
    features = vec.get_feature_names() # the unique words 
    doc_vector = matrix[n]
    df = pd.DataFrame(doc_vector.T.todense(), index=features, columns=["tfidf"])
    df.sort_values(by=["tfidf"], ascending=False, inplace=True)
    print(df.head(10))

def test_print():
    corpus = ["another day of rain; rain rain go away, comeback another day"]
    vec, matrix = build_tf_idf_model(corpus)
    print_tfidf(vec,matrix)</code></pre></div><p class="new">Be sure you run <code>test_print</code> and understand what you are seeing. As a reminder,
the matrix is a sklearn <strong>sparse matrix</strong> discussed in the tf‚Ä¢idf-skl lesson. </p><h3 id="exercise-the-harry-potter-tfidf">Exercise: The Harry Potter TF‚Ä¢IDF</h3><p class="new">Modify the <code>test_print</code> function to do the following:</p><ul><li>build the Harry Potter corpus using only the first book</li><li>when you build the tf_idf_model, pass in the list of stopwords 
(use <code>Util.load_stopwords</code> -- which you can pass in an extra array of words)</li></ul><p class="new">When you run <code>test_print</code>, you should see the following:</p><pre><code>             tfidf
harry     8.189168
said      7.677083
ron       7.061457
hagrid    6.913503
hermione  6.594711
back      6.564520
one       6.545177
know      6.365976
got       6.293305
didn      6.293305</code></pre><p class="new">Go ahead and add 'said' the the list of stopwords and re-run <code>test_print</code>.</p><h3 id="a-pause-for-testing">A Pause for Testing</h3><p class="new">Even though we are on our way to building a query engine, you might have
 noticed we have taken a lot of time to write some code and then test that
 code. This model of iterative, test-driven programming is what you always
 want to do.  Usually, you will use a full test harness that you can test
 your code automatically. But building small in-place test cases works great
 while we are learning a new library or experimenting.</p><h3 id="testing-the-query">Testing the Query</h3><p class="new">We have most of the pieces in place.  The next thing you will want to do
is build a function that accepts a query (as a string) and 'transforms' this
to another matrix.  Essentially, you are taking your 'test' data (the query) 
(or data that the model hasn't been formally trained on) and pushing it 
through the tf‚Ä¢idf machinery you built.  The output will be another matrix.   </p><p class="new">Finish the following implementation:</p><ul><li><code>prepare_query_v1</code> has 2 named parameters: <code>corpus</code> and <code>query</code>
<ul><li><code>corpus</code> is the list of documents; default value: <code>None</code></li><li><code>query</code> is a string; default value: empty string</li></ul></li><li>if <code>corpus</code> is None, build one (using <code>build_tf_idf_model</code>) with the first 3 Harry Potter books</li><li>return the transformed query (another sparse matrix)</li></ul><div class="ide code-starter clearfix"><pre><code>def prepare_query_v1():
   pass</code></pre></div><p class="new">A few notes and hints:</p><ul><li>the query only needs to transformed NOT <strong>fit</strong>ed.  If you fit and
transform, you are building and training a new model.</li><li>what you pass into the vectorizer to be transformed is an array of one
element:  the query string.  Each item in the array is considered a
separated document.  The query (a group of words) is the only document.</li></ul><p class="new">And of course we need to test this (add in the following):</p><pre><code>def dump_sparse_vector(v):
  coo_m = v.tocoo()
  for r,c,d in zip(coo_m.row, coo_m.col, coo_m.data):
    print('non zero at', r,c,d)

def test_single_query(query):
  q_vec = prepare_query_v1(query=query)
  dump_sparse_vector(q_vec)

test_single_query('harry potter')</code></pre><p class="new">For this example, the query has two words; so the sparse matrix will have
 exactly two non zero values in it.  Be sure you can answer the following
 questions:</p><ul><li><strong>Q1:</strong> what happens if you pass in a string that the model hasn't seen? (e.g INFO490)</li><li><strong>Q2:</strong> what happens if you pass in a string with duplicate values in it?</li></ul><h1 class="section" id="section3">Measuring Similarity</h1><img alt="HPImposter.png" class="iw200 bg-blue-200 float-right ml-3 border mt-1 py-3" src="https://raw.githubusercontent.com/habermanUIUC/CodeStoryLessons/main/lessons/dmap/projects/hp411/html/HPImposter.png"/><p class="new">Here's where you are: </p><ul><li>You have a document matrix, where each row represents a Harry Potter book (td ‚Ä¢idf values).</li><li>You have a query vector, where each column represents a tf value for each word
(actually it's a tf‚Ä¢idf value, but all the idf values are 1.  Do you know why?)</li></ul><p class="new">NOW, we just need to measure how similar the query vector (a single document) 
is to each row in the matrix.  The row in the matrix that is most similar to the query wins. 
We need a way to compare two vectors and determine how 'similar' they are. </p><p class="new">One easy way to think about calculating similarity is using the distance
 formula between two points.  Each point has an x and y component.  So each
 point is a vector of length two.  And the distance between two points is
 simply the square root of the sum of squared differences:</p><img alt="math?math=%5CLarge%20distance(p1%2Cp2)%20%3D%20%5Csqrt%7B%20(p1.x%20-%20p2.x)%5E2%20%2B%20(p1.y%20-%20p2.y)%5E2%7D" class=" formula-block" src="https://render.githubusercontent.com/render/math?math=%5CLarge%20distance(p1%2Cp2)%20%3D%20%5Csqrt%7B%20(p1.x%20-%20p2.x)%5E2%20%2B%20(p1.y%20-%20p2.y)%5E2%7D"/><br/><p class="new">However, this formula has some issues that we will discuss in detail on a
 lesson that covers different distance metrics.  For now, we are going to use a
metric called cosine similarity -- which is used for determining how close 
two documents (as vectors) are (because it normalizes the length of each
 document).  </p><h2 id="cosine-distancesimilarity">Cosine Distance/Similarity</h2><p class="new">One of the main metrics for working with document vectors is cosine similarity. 
This metric relies on normalizing the two input vectors so that 'bigger' (i.e. longer') 
vectors don't over influence the calculation (e.g. just because a document 
contains more words doesn't make it more important).</p><p class="new">We can visualize cosine similarity (the value of ùõ≥ in the image below) to show
the distance between to words (the value d represents euclidean distance):
<img alt="eucos.png" class="my-6 border iw300 center" src="https://raw.githubusercontent.com/habermanUIUC/CodeStoryLessons/main/lessons/dmap/projects/hp411/html/eucos.png"/>Specifically the the cosine distance is defined as: 
<img alt="math?math=%5CLarge%20cosine%5C_similarity(A%2C%20B)%20%3D%20%5Cfrac%7BA%20%5Ccdot%20B%0A%7D%7B%5Cleft%20%5C%7C%20A%20%5Cright%20%5C%7C%5Cleft%20%5C%7C%20B%20%5Cright%20%5C%7C%7D" class="my-4 center formula-block" src="https://render.githubusercontent.com/render/math?math=%5CLarge%20cosine%5C_similarity(A%2C%20B)%20%3D%20%5Cfrac%7BA%20%5Ccdot%20B%0A%7D%7B%5Cleft%20%5C%7C%20A%20%5Cright%20%5C%7C%5Cleft%20%5C%7C%20B%20%5Cright%20%5C%7C%7D"/>However, we will wait until the lesson on metrics to discuss (in great detail) the 
meaning of both <img alt="math?math=%5CLarge%20A%20%5Ccdot%20B" class="inline formula-block" src="https://render.githubusercontent.com/render/math?math=%5CLarge%20A%20%5Ccdot%20B"/> (dot product) and 
<img alt="math?math=%5CLarge%20%5Cleft%20%5C%7C%20A%20%5Cright%20%5C%7C" class="inline formula-block" src="https://render.githubusercontent.com/render/math?math=%5CLarge%20%5Cleft%20%5C%7C%20A%20%5Cright%20%5C%7C"/> (vector (L2) normalization). 
You can say the cosine distance between two vectors looks at the angle between 
the two and not their magnitude.</p><p class="new">Luckily we can use sklearn's metrics for similarity. The nice thing about sklearn's 
metrics is that they automatically work with sparse matrices. The following 
shows how to use the metric:</p><pre><code>from sklearn.metrics.pairwise import cosine_similarity
def print_matching_document(matrix, q_vector):

  assert q_vector.shape[0] == 1, "bad query vector (wrong size)"

  for m_idx, m in enumerate(matrix):
    for q_idx, q in enumerate(q_vector):
      print(cosine_similarity(m,q))</code></pre><p class="new">This is the first time we are seeing the <code>assert</code> operator.  It will throw a
 run time exception if the condition is not met (and print the corresponding
 message).  However, in production code, you will usually automatically
 remove them.  They are a great tool while developing code to help capture
 the semantics of a possible error.  Also note (when you run this code) the
 returned value from <code>cosine_similarity</code>. Be sure to type the above code in 
and run it.  It will help. </p><p class="new">With that as an example, finish the following code block:</p><ul><li><code>find_matching_document</code> returns a tuple of the index and distance of the <code>matrix</code> 
that is closest to <code>q_vector</code>
<ul><li>the first value of the tuple is the index, the second is the the distance</li></ul></li><li><code>find_match</code> builds the query vector from the query string
  <ul><li>use the TfidfVectorizer's <a href="https://scikit-learn.org/stable/modules/generated/sklearn.feature_extraction.text.TfidfVectorizer.html" target="_blank">transform</a> method</li><li>it's essentially the same as <code>prepare_query_v1</code></li><li>returns the value from <code>find_matching_document</code></li></ul></li></ul><div class="ide code-starter clearfix"><pre><code>from sklearn.metrics.pairwise import cosine_similarity
def find_matching_document(matrix, q_vector):
   # return a tuple of
   #  the index of the matrix (row) which is most similar to q_vector
   #  the cosine distance 
   return None,None

def find_match(query, corpus_size=3):
  corpus = build_corpus(corpus_size)
  vec, matrix = build_tf_idf_model(corpus)
  
  #
  # build q_vector here
  #
  
  return find_matching_document(matrix, q_vector)</code></pre></div><p class="new">Once that is done, you are almost done!.  Below are two simple tests (with
 the output):</p><pre><code>print(find_match(query="harry potter pretend", corpus_size=3))
[[0.0467311]]
[[0.04231436]]
[[0.04107885]]
0

print(find_match(query="muggle",corpus_size=3))
[[0.02046469]]
[[0.02305858]]
[[0.01797005]]
1

# test it too
print(ide.tester.test_function('find_matching_document'))</code></pre><h1 class="section" id="section4">A Quick Review</h1><img alt="tfidfModel.png" class="iw400 mb-3 float-left mr-3 border" src="https://raw.githubusercontent.com/habermanUIUC/CodeStoryLessons/main/lessons/dmap/projects/hp411/html/tfidfModel.png"/><p class="new">Just to recap to ensure we understand the big picture. You created a 
matrix that represents a tf‚Ä¢idf vectors for each document.  </p><p class="new">You first used the <code>fit_transform</code> method of the <code>TfidfVectorizer</code> class. 
Then you created a vector that represents the tf‚Ä¢idf vector of the query. 
Since you used the same model that was 'fitted' with the Harry Potter corpus, 
the transform treated the query as a single 'unseen' document (one that it was 
never trained/fitted on).</p><p class="new">Finally, you used the cosine similarity metric to find the closest matching
 document.
<br/></p><h1 class="section" id="section5">The User Interface (UI)</h1><p class="new">Like shopping at Honeydukes (HP; Prisoner of Azkaban -- go ahead and confirm it), 
the excitement of being so close to the end is hard to contain.</p><p class="new">Think of the UI as a simple functional prototype.  You just need to show it can 
be done. </p><p class="new">You have already written most of the code.  We will guide you through the missing
 parts.  Be sure to read the section after this code block for detailed information:</p><div class="ide code-starter clearfix"><pre><code>import matplotlib.pyplot as plt
import LessonUtil as Util

def show_image(path):
  with open(path, 'rb') as fd:
    fig, ax = plt.subplots()
    ax.set_axis_off()
    imgdata = plt.imread(fd)
    im = ax.imshow(imgdata)
    return fig

def test_UI(vec=None, matrix=None, query='', debug=False):
  
  # build vec, matrix if either parameter is None
  # use the full harry potter corpus if you need to build 
  
  #
  # transform the query string
  #
  
  #
  # find the matching document
  #
  
  #
  # if no document matches, use the first document
  #

  #
  # get path for the image 
  #

  # display the image (uncomment when ready)
  # show_image(path)  
  
  # return the winning index
  return idx</code></pre></div><h2 id="getting-images">Getting Images</h2><p class="new">Inside the lesson assets are all the Harry Potter Book images.  They are named
hp1.png through hp7.png (similar to the hp1.txt .. hp7.txt documents). You 
can use <code>Util.path_for_data</code> passing it the appropriate .png filename. We 
will use matplotlib to show the images. </p><p class="new">Note we are using the powerful <code>imshow</code> method from matplotlib.</p><pre><code>path = Util.path_for_data('hp1.png')
show_image(path)</code></pre><h2 id="printing-output">Printing Output</h2><p class="new">The <code>debug</code> flag is used so you can toggle whether or not you want to print
 out distances.  You must update <code>find_matching_document</code> for the <code>debug</code> 
parameter. If <code>debug</code> is true, print out both the index and distance.</p><h2 id="testing-the-ui">Testing the UI</h2><img alt="output.png" class="iw200 float-left mr-3 border mb-3 mt-1" src="https://raw.githubusercontent.com/habermanUIUC/CodeStoryLessons/main/lessons/dmap/projects/hp411/html/output.png"/><p class="new">Finally you should test your code.  A few edge cases to handle: </p><ul><li>if no documents match the query, you can show the first book</li><li>if there is a tie, you can show the first matching book</li></ul><p class="new">Both of these situations don't have to be 'coded' in if your <code>find_matching_document</code>
is set up properly.</p><pre><code># test it
print(test_UI(query='muggle', debug=True))</code></pre><p class="new">If you haven't read Harry Potter and need to verify, there's plenty of fan
 sites that provide a lot of information.  Here's a <a href="https://harrypotter.fandom.com/wiki/Amortentia" target="_blank">popular</a> site.</p><h2 id="a-better-performing-ui">A Better Performing UI</h2><p class="new">Once that is working, you can pull out (refactor) the model building and 
reuse the query machinery without rebuilding each time:</p><div class="ide code-starter clearfix"><pre><code>corpus = build_corpus(7)
vec, matrix = build_tf_idf_model(corpus)

# now I can reuse vec &amp; matrix 
test_UI(vec, matrix, "muggle")          # chamber of secrets
test_UI(vec, matrix, "winky")           # goblet of fire
test_UI(vec, matrix, "lupin")           # prisoner of azkaban
test_UI(vec, matrix, "lupin champions") # goblet of fire</code></pre></div><h2 id="user-input-ui">User Input UI</h2><p class="new">Finally, we can add a form field and allow a user to input query words</p><div class="ide code-starter clearfix"><pre><code>input = "muggle and muggles" #@param {type:"string"}
test_UI(vec, matrix, input, debug=True)</code></pre></div><p class="new">Note that the 'comment' <code>#@param {type:"string"}</code> is parsed by the colab
 notebook to create a user input field.  There are several different types of
 input fields you can use to create pseudo (prototype/rough draft) interfaces. </p><img alt="menuUI.png" class="iw400 float-left mb-3 mr-3 border mt-1" src="https://raw.githubusercontent.com/habermanUIUC/CodeStoryLessons/main/lessons/dmap/projects/hp411/html/menuUI.png"/><p class="new">You can even close the code portion to have a better user experience.</p><h2 id="testing">Testing</h2><p class="new">You can use the ide test framework to ensure everything is working.  However,
it order to make the tests run efficiently, please comment out the two lines
 of code that build the model.</p><pre><code>#corpus = build_corpus(7)
#vec, matrix = build_tf_idf_model(corpus)
vec, matrix = None,None

ide.tester.test_functionality('hp411')</code></pre><h1 class="section" id="section6">Rock Cakes for Thought and Talk</h1><p class="new">Think about the following questions, you can discuss them on piazza too:</p><ul><li>What would be the effect of removing stop words?</li><li>Is the query string an 'or' operation or an 'and' operation?</li><li>What if you wanted to implement both?
<ul><li>query words 'lupin' AND 'harry'</li><li>query words 'lupin' OR 'harry'</li></ul></li><li>Rather than doing single words, would ngrams be a better/worse idea?</li></ul><p class="new">Hopefully, you can feel pretty good about all your accomplished in this
 lesson. Be sure to re-visit everything you read and did -- the information
 will be referenced throughout this class.</p><h1 class="section" id="section7">Extra Credit Fun </h1><img alt="extraCredit.png" class="iw500 border mb-1" src="https://raw.githubusercontent.com/habermanUIUC/CodeStoryLessons/main/lessons/dmap/projects/hp411/html/extraCredit.png"/><p class="new">For extra credit rather than showing one book, show all the books in order.</p><ul><li>if no books match, show nothing</li><li>show only books with a distance &gt; 0</li></ul><p class="new">The following functions need to implemented:</p><ul><li><code>find_matching_documents</code>
<ul><li>returns a list of tuples (instead of a single tuple)</li><li>if no match, return the empty list</li></ul></li><li><code>show_images</code>
<ul><li>it's parameter is a list of paths</li><li>return <code>None</code> if <code>paths</code> is empty otherwise return the figure</li><li>your figure should have a subplot for each image displayed (1 row, N columns)</li></ul></li><li><code>test_extra_UI</code>
<ul><li>same functionality of <code>test_UI</code>, but uses the new functions</li><li>rather than returning the index tuple, return the figure (from <code>show_images</code>)</li></ul></li></ul><div class="ide code-starter clearfix"><pre><code># ide.tester.test_functionality('extra_credit')</code></pre></div><h1>Test and Submit</h1><p>Once you have finished, you can download your code (via <code>ide.tester</code>) and upload that file to Gradescope (find lesson with tag <strong>Py</strong>).</p><div class="my-4"><pre><code><strong># to list the tests available</strong><br/>print(ide.tester.list_tests())<br/><strong># to perform a specific test</strong><br/>print(ide.tester.test_functionality('name of test'))<br/><strong># to test your code (either works)</strong><br/>print(ide.tester.test_notebook())<br/>print(ide.tester.test_notebook(verbose=True))<br/><strong># to prepare and download your code</strong><br/>ide.tester.download_solution()</code></pre></div><div class="lesson-footer flex bg-gray-200 justify-center"><div class="lesson-footer-card displaycard bg-blue-200 border-t border-gray-400 max-w-2xl rounded overflow-hidden shadow-lg"><div class="px-6 py-4"><div class="title-text text-center font-bold text-xl">Finding Mr. Potter</div><p class="text-center text-gray-800 text-xl">using tf‚Ä¢idf for üßô 411 </p><div class="text-center mt-6 text-xl"><i aria-hidden="true" class="fas fa-tags"></i> any questions on Piazza with <span class="font-bold">Py</span></div><div class="text-gray-700 text-base">¬†</div><div></div><div></div><div class="flex mt-4 border-t border-solid border-gray-500 justify-around bg-gray-200"><div class="text-gray-700 text-center px-4 m-2 text-sm">D.M. &amp; the üêç</div><div class="text-gray-700 text-center px-4 m-2 text-sm"><strong>Version:</strong> <!-- -->SP21</div></div><div class="text-gray-700 mt-2 text-center text-sm font-bold">All Rights Reserved Michael Haberman</div><div class="text-gray-700 text-center text-sm">Do not distribute this notebook</div></div></div></div><div>¬†</div><div class="ide code-starter clearfix"><pre><code># print(ide.tester.test_notebook()) 
# print(ide.tester.test_notebook(verbose=True)) 

# once you are ready -- run this 
# ide.tester.download_solution() 
</code></pre></div></div></div></body></html>